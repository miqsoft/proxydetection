before:
  - ../x_setup_socks5_updown_http_heartbeat_crypt_nopass.yml
after:
  - ../x_teardown_heartbeat.yml
  - ../x_teardown.yml
tasks:
  - host: client
    task:
      name: "websocat the server"
      ansible.builtin.shell:
          cmd: "(echo 'Hello Server'; sleep 5) | websocat --socks5 127.0.0.1:1080 ws://{{ hostvars['server']['reserved_ip'] }}:8100 2>&1 | tee /output/client_ws.log"
  - host: client
    task:
      name: "Save the websocket client log"
      include_tasks: "commands/fetch_and_empty.yml"
      vars:
        src: "/output/client_ws.log"
        dst: "{{ log_dir }}/client_ws.log"
  - host: server
    task:
      name: "Save the websocket server log"
      include_tasks: "commands/fetch_and_empty.yml"
      vars:
        src: "/output/server_ws.log"
        dst: "{{ log_dir }}/server_ws.log"
  - host: server
    task:
      name: "Restart the server"
      shell:
        cmd: "service ws restart"
